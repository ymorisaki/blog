---
template: BlogPost
path: /2020-03-30
date: 2020-03-30
title: HTMLCollectionはコンテンツモデルに反したセマンティクス構造を許容しないらしい
thumbnail: /assets/img/img-01.jpg
metaDescription: HTMLCollectionはコンテンツモデルに反したセマンティクス構造を許容しないらしい
---

マークアップ構造をテストしてクリアしていたらtrueを返し、クリアしていなかったらfalseを返すJSを書いていたときに妙なことに気がつきました。

明らかにテストパターンではfalseを返すはずなのにtrueが返っているパターンがある....

例えば以下のp要素があったとして、以下のようなJSを実行したとします。

```
<p id="hoge">この文章は<em>テスト</em>です。</p>

hoge.children
// HTMLCollection [em]
// length: 1
// 0: em
```

`id="hoge"`の中には一つの配列が存在し、０番目は`em`である。

何も難しいことはないですね。

問題なのは以下のようなパターンです。

```
<p id="hoge"><div>この文章は</div><em>テスト</em>です。</p>
```

HTML5のコンテンツモデルは色々なルールがありますが、その辺りはさておきとにかくp要素はdiv要素を内包することが出来ません。

しかし、往々にしてそういった間違ったマークアップも運用する上では発生してしまうものです。

そのため、マークアップ置き換えの機能を作成する必要が出てきたのでテストを行うJSを書いていた際に以下の挙動に気がつきました。

```
<p id="hoge"><div>この文章は</div><em>テスト</em>です。</p>

hoge.children
// HTMLCollection []
// length: 0
```

**あれ！？中身なくなってない！！？？**

いろいろ試しても、コンテンツモデルに反した要素にたどり着いた時点で処理が終了してしまうのです。

たとえば以下のようなパターンはこうなります。

```
<p id="hoge">この文章は<em>テスト</em>です。<div>この文章は</div><em>テスト</em>です。</p>

hoge.children

// 期待される挙動
// HTMLCollection [em]
// length: 3
// 0: em
// 1: div
// 2: em

// 実際の挙動
// HTMLCollection [em]
// length: 1
// 0: em
```

`div`の時点で処理が止まっているように見えます。

## その謎を解明すべく我々はアマゾンの奥地へ...